<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Custom Markdown Parser</title>
    <style>
        body { display: flex; height: 100vh; margin: 0; }

        #input, #output { padding: 1em; resize: none; }
        #input:focus { outline: none; }
        #document { overflow-y: scroll; flex: 1; }
    </style>
    <script>
        function generatePDF() {

            // https://www.geeksforgeeks.org/how-to-design-runtime-generated-pdf-via-html/

            let mywindow = window.open("", "PRINT", "height=400,width=600");
    
            mywindow.document.write(document.getElementById("document").innerHTML);
    
            mywindow.document.close();
            mywindow.focus();
    
            mywindow.print();
            mywindow.close();
        }
        
        function processInline(prefixClip, line) {

            // remove prefix
            line = line.substring(prefixClip);
            
            // replace ligatures
            line = line.replaceAll("<-", "←").replaceAll("->", "→").replaceAll("!=", "≠");

            // italics, bold, and bold italics (not maximally efficient, don't care)
            let index = 0;
            
            while ((index = line.indexOf("***", index)) != -1 && line.indexOf("***", index + 3) != -1) {
                
                line = line.replace("***", "<i><strong>").replace("***", "</strong></i>");
            }

            while ((index = line.indexOf("**", index)) != -1 && line.indexOf("**", index + 2) != -1) {
                
                line = line.replace("**", "<strong>").replace("**", "</strong>");
            }

            while ((index = line.indexOf("*", index)) != -1 && line.indexOf("*", index + 1) != -1) {
                
                line = line.replace("*", "<i>").replace("*", "</i>");
            }

            return line;
        }
        
        function parse() {
            
            const out = document.getElementById("output");
            out.innerHTML = "";
            
            const lines = document.getElementById("input").value.split("\n");

            let passage = "";
            let passageType = -1; // 0 = paragraph, 1 = unordered, 2 = ordered, 3 = checkbox, 4 = blockquote

            for (const line of lines) {

                // skip blank lines
                if (line.trim().length === 0)
                    continue;

                // passages are prefix:data pairs that take up more than one line
                if (passageType === 0) {

                    if (line.charAt(0) == '+') {
                        
                        passage += " " + processInline(1, line);
                        continue;
                    }
                    
                    out.innerHTML += `<p>${ passage }</p>`;
                }

                else if (passageType === 1) {

                    if (line.indexOf("- ") == 0) {
                        
                        passage += `<li>${ processInline(2, line) }</li>`;
                        continue;
                    }

                    out.innerHTML += `<ul>${ passage }</ul>`;
                }

                else if (passageType === 2) {

                    if (line.indexOf("-. ") == 0) {
                        
                        passage += `<li>${ processInline(3, line) }</li>`;
                        continue;
                    }

                    out.innerHTML += `<ol>${ passage }</ol>`;
                }

                else if (passageType === 3) {

                    if (line.indexOf("[ ] ") == 0) {
                        
                        passage += `<li class="unchecked">${ processInline(4, line) }</li>`;
                        continue;
                    }

                    else if (line.indexOf("[X] ") == 0) {

                        passage += `<li class="checked">${ processInline(4, line) }</li>`;
                        continue;
                    }

                    out.innerHTML += `<ul>${ passage }</ul>`;
                }

                else if (passageType === 4) {

                    if (line.indexOf("> ") == 0) {
                        
                        passage += `<p>${ processInline(2, line) }</p>`;
                        continue;
                    }

                    out.innerHTML += `<blockquote>${ passage }</blockquote>`;
                }
                
                passage = "";
                passageType = -1;

                // prefix:data pairs (prefix indicates what kind of element data represents)
                if (line.indexOf("@ ") == 0) {
                    out.innerHTML += `<img src="${ line.substring(2) }">`;
                } else if (line.indexOf("### ") == 0) {
                    out.innerHTML += `<h3>${ processInline(4, line) }</h3>`;
                } else if (line.indexOf("## ") == 0) {
                    out.innerHTML += `<h2>${ processInline(3, line) }</h2>`;
                } else if (line.indexOf("# ") == 0) {
                    out.innerHTML += `<h1>${ processInline(2, line) }</h1>`;

                } else if (line.indexOf("> ") == 0) {
                    passage += `<p>${ processInline(2, line) }</p>`;
                    passageType = 4;
                } else if (line.indexOf("[ ] ") == 0) {
                    passage += `<li class="unchecked">${ processInline(4, line) }</li>`;
                    passageType = 3;
                } else if (line.indexOf("[X] ") == 0) {
                    passage += `<li class="checked">${ processInline(4, line) }</li>`;
                    passageType = 3;
                } else if (line.indexOf("-. ") == 0) {
                    passage += `<li>${ processInline(3, line) }</li>`;
                    passageType = 2;
                } else if (line.indexOf("- ") == 0) {
                    passage += `<li>${ processInline(2, line) }</li>`;
                    passageType = 1;
                } else {
                    passage += processInline(0, line);
                    passageType = 0;
                }
            }

            if (passage.length !== 0) {
                
                if (passageType === 0) {
                    out.innerHTML += `<p>${ passage }</p>`;
                } else if (passageType === 1) {
                    out.innerHTML += `<ul>${ passage }</ul>`;
                }
            }
        }
    </script>
</head>
<body onload="parse();">

    <div style="flex: 1; display: flex; flex-direction: column;">
        <div style="text-align: right; border-right: 1px solid grey; padding: 2px;">
            <button type="button" onclick="generatePDF();">Generate PDF</button>
        </div>
        <textarea id="input" oninput="parse();" style="flex: 1; border: 1px solid grey; border-radius: 0; margin: 0;">
# Custom Markdown Parser

## Inline

You can make text *italicized*, **bold**, or ***both***.

## Ligatures

<-, ->, !=

## Lists

### Unordered

- Apples
- Oranges
- Pears

### Ordered

-. Kings
-. Queens
-. Knights

### Checkbox

[X] Mix flour and eggs.
[ ] Pour into tray.
[ ] Bake for 30 minutes.

## Blockquotes

Here's a quote:

> “Be yourself; everyone else is already taken.”
> ― Oscar Wilde
        
## Line merging

This line will not get merged.
Hi im another line.

This line will get merged
+with this line.
    
## Example Excerpt

@ https://i.natgeofe.com/n/548467d8-c5f1-4551-9f58-6817a8d2c45e/NationalGeographic_2572187_3x4.jpg

The cat (Felis catus), also referred to as the domestic cat, is
+a small domesticated carnivorous mammal. It is the only domesticated
+species of the family Felidae. Advances in archaeology and genetics
+have shown that the domestication of the cat occurred in the Near
+East around 7500 BC.
        
Cats are commonly kept as a pet and farm cat, but also ranges freely
+as a feral cat avoiding human contact. It is valued by humans for
+companionship and its ability to kill vermin. Its retractable claws
+are adapted to killing small prey species such as mice and rats.</textarea>
    </div>

    <div id="document">
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Hind:wght@300;400;500;600;700&display=swap');
        
            #output { font-family: "Hind", sans-serif; }
            
            img { max-width: 300px; max-height: 300px; float: right; clear: right; border: 2px outset lightgrey; margin-left: 1em; margin-bottom: 1em; }

            h1, h2, h3 { clear: right; }
            h1, h2 { border-bottom: 1px solid lightgrey; }

            blockquote { background: #eee; padding: 1px 1em; border-radius: 0.5em; margin: 1em 0; }
    
            li.unchecked, li.checked { list-style: none; position: relative; }
            li.unchecked:before, li.checked:before { content: ""; border: 1.5px solid black; width: 10px; height: 10px; position: absolute; left: -18px; top: 2px; border-radius: 2px; }
            li.checked:after { content: "✓"; color: #2af; position: absolute; left: -16px; top: -3px; text-shadow: 0 0 2px white, 0 0 2px white, 0 0 2px white, 0 0 2px white, 0 0 2px white, 0 0 2px white, 0 0 2px white, 0 0 2px white, 0 0 2px white, 0 0 2px white, 0 0 2px white, 0 0 2px white, 0 0 2px white, 0 0 2px white, 0 0 2px white, 0 0 2px white, 0 0 2px white, 0 0 2px white; }
        </style>
        <div id="output"></div>
    </div>
        
</body>
</html>
